<div class="create-party-panel full-height">
  <div class="container">
    <h2 class="section-title">{{ editMode ? 'Zarządzaj drużyną' : 'Stwórz drużynę' }}</h2>

    <form [formGroup]="teamForm" (ngSubmit)="onSubmit()" class="user-info-form">
      <div class="form-group">
        <label class="text-start">Założyciel</label>
        <div class="text-start font-size-medium">
          {{ ownerDisplayName() }}
        </div>
      </div>

      <div class="form-group">
        <label for="teamName" class="text-start">Nazwa drużyny</label>
        <input id="teamName" type="text" formControlName="name" class="form-control" />
      </div>

      <!-- GM -->
      <div class="form-group">
        <label class="text-start">Mistrz Gry</label>
        <app-gm-picker
          [gms]="gmsList()"
          [selectedId]="teamForm.get('gmId')?.value"
          (selectedChange)="onGmChange($event)">
        </app-gm-picker>

        <div class="form-text mt-1">
          @if (teamForm.get('gmId')?.value) {
            Lista systemów poniżej jest ograniczona do tych, które prowadzi wybrany MG.
          } @else {
            Wybierz MG, aby zawęzić listę systemów.
          }
        </div>
      </div>

      <div class="form-group">
        <label for="description" class="text-start">Opis</label>
        <textarea id="description" class="form-control" formControlName="description" rows="7"></textarea>
      </div>

      <div class="form-group form-check text-start">
        <input id="addSelf" class="form-check-input" type="checkbox" formControlName="addSelf" />
        <label class="form-check-label" for="addSelf">Dodaj mnie jako członka drużyny</label>
      </div>

      <!-- Members -->
      <div class="form-group text-start">
        <label>Dodaj członków drużyny (maks. 5)</label>

        <app-party-members-picker
          [users]="membersList()"
          [selectedIds]="membersControls.value"
          [pending]="pendingMembers()"
          [activeSet]="dbActiveMemberIds()"
          [isClubParty]="teamForm.get('isClubParty')?.value"
          [canShowEmails]="
            editMode && partyData && user()?.id === partyData.ownerId
          "
          [showPending]="editMode"
          (selectedChange)="onMembersChange($event)"
          (removeDbActive)="onRemoveDbActive($event)"
          (acceptPending)="acceptPending($event)"
          (rejectPending)="rejectPending($event)"
          (nonClubAttempt)="onNonClubAttempt()">
        </app-party-members-picker>
      </div>

      <!-- Systems -->
      <div class="form-group text-start">
        <label>Systemy RPG (maks. 5)</label>
        <app-systems-picker
          [systems]="systemsList()"
          [allowedIds]="allowedSystemIds"
          [selectedIds]="systemControls.value"
          [gmSelected]="!!teamForm.get('gmId')?.value"
          (selectedChange)="onSystemsChange($event)">
        </app-systems-picker>
      </div>

      <!-- Style tags -->
      <div class="form-group text-start">
        <label>Styl drużyny (maks. 3)</label>
        <style-tags
          [selected]="styleTagControls.value"
          (selectedChange)="onStylesChange($event)">
        </style-tags>
      </div>

      <div class="form-group text-start">
        <label for="notes">Notatki</label>
        <textarea id="notes" class="form-control" formControlName="notes"></textarea>
      </div>

      <div class="form-group form-check">
        <input id="isOpen" class="form-check-input" type="checkbox" formControlName="isOpen" />
        <label class="form-check-label me-4" for="isOpen">Dostępna dla innych</label>

        @if (canSeeClubOnly()) {
          <input
            id="isClubParty"
            class="form-check-input"
            type="checkbox"
            formControlName="isClubParty"
            (change)="onClubOnlyToggle(teamForm.get('isClubParty')?.value)" />
          <label class="form-check-label" for="isClubParty">Tylko dla Klubowiczów</label>
        }
      </div>

      <button type="submit" class="btn btn-primary mt-3">
        {{ editMode ? 'Zapisz zmiany' : 'Utwórz drużynę' }}
      </button>
    </form>
  </div>

  <ng-template #partySuccessToast>
    <strong>Sukces!</strong> Drużyna została {{ modeSuccessMessage }}.
  </ng-template>

  <ng-template #partyErrorToast>
    <strong>Błąd!</strong> Nie udało się {{ modeFailMessage }} drużyny.
  </ng-template>
</div>
