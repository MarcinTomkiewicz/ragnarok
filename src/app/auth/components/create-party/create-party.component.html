<div class="form-panel gm-profile-panel full-height">
  <div class="container">
    <h2 class="section-title">Stwórz drużynę</h2>

    <form [formGroup]="teamForm" (ngSubmit)="onSubmit()" class="w-100">
      <div class="form-group">
        <label class="text-start">Założyciel</label>
        <div class="text-start font-size-medium">
          {{ getUserDisplayName(user()) }}
        </div>
      </div>

      <div class="form-group">
        <label for="teamName" class="text-start">Nazwa drużyny</label>
        <input
          id="teamName"
          type="text"
          formControlName="name"
          class="form-control"
        />
      </div>

      <div class="form-group">
        <label for="gmSelect" class="text-start">Mistrz Gry</label>
        <select id="gmSelect" formControlName="gmId" class="form-select">
          <option [ngValue]="null">Bez Mistrza Gry</option>
          @for (gm of gmsList(); track $index) {
          <option [ngValue]="gm.userId">{{ gmDisplayName(gm) }}</option>
          }
        </select>
      </div>

      <div class="form-group">
        <label for="description" class="text-start">Opis</label>
        <textarea
          id="description"
          class="form-control"
          formControlName="description"
          rows="7"
        ></textarea>
      </div>

      <div class="form-group form-check text-start">
        <input
          id="addSelf"
          class="form-check-input"
          type="checkbox"
          formControlName="addSelf"
        />
        <label class="form-check-label" for="addSelf">
          Dodaj mnie jako członka drużyny
        </label>
      </div>

      <div class="form-group text-start">
        <label for="membersSelect">Dodaj członków drużyny (maks. 5)</label>
        <input
          type="text"
          class="form-control mb-2"
          placeholder="Wyszukaj użytkowników"
          (input)="onSearchChange($event, 'members')"
        />
        <select
          id="membersSelect"
          class="form-select mb-2 w-100"
          multiple
          size="5"
          (change)="onItemChange($event, 'members')"
        >
          @for (member of filteredMembers; track member.id) {
          <option
            [value]="member.id"
            [disabled]="
              membersControls.value.length >= 5 &&
              !membersControls.value.includes(member.id)
            "
          >
            {{ getUserDisplayName(member) }} - {{ member.email }}
          </option>
          }
        </select>

        @if (membersControls.value.length > 0) {
        <label>Wybrani członkowie:</label>
        <ul class="list-group">
          @for (memberId of membersControls.value; track $index) {
          <li class="text-start list-group-item">
            <div class="flex-row-align-start">
              {{ getMemberNameById(memberId) }}
              <button
                type="button"
                class="btn btn-danger btn-close-x"
                (click)="removeItem(memberId, 'members')"
              >
                x
              </button>
            </div>
          </li>
          }
        </ul>
        }
      </div>

      <!-- Systemy RPG -->
      <div class="form-group text-start">
        <label for="systemsSelect">Systemy RPG (maks. 5)</label>
        <input
          type="text"
          class="form-control mb-2"
          placeholder="Wyszukaj system"
          (input)="onSearchChange($event, 'systems')"
        />
        <select
          id="systemsSelect"
          class="form-select mb-2 w-100"
          multiple
          size="5"
          (change)="onItemChange($event, 'systems')"
        >
          @for (system of filteredSystems; track system.id) {
          <option
            [value]="system.id"
            [disabled]="
              systemControls.value.length >= 5 &&
              !systemControls.value.includes(system.id)
            "
          >
            {{ system.name }}
          </option>
          }
        </select>

        @if (systemControls.value.length > 0) {
        <label>Wybrane systemy:</label>
        <ul class="list-group">
          @for (systemId of systemControls.value; track $index) {
          <li class="text-start list-group-item">
            <div class="flex-row-align-start">
              {{ getSystemNameById(systemId) }}
              <button
                type="button"
                class="btn btn-danger btn-close-x"
                (click)="removeItem(systemId, 'systems')"
              >
                x
              </button>
            </div>
          </li>
          }
        </ul>
        }
      </div>

      <div class="form-group text-start">
        <label>Styl drużyny (maks. 3)</label>
        <div class="d-flex flex-wrap gap-2">
          @for (tag of gmStyleTagValues; track tag) {
          <div class="style-checkbox">
            <input
              class="style-checkbox-input"
              type="checkbox"
              [checked]="styleTagControls.value.includes(tag)"
              [disabled]="
                styleTagControls.value.length >= 3 &&
                !styleTagControls.value.includes(tag)
              "
              (change)="toggleStyleTag(tag)"
              id="style_{{ tag }}"
            />
            <label class="style-checkbox-label" [for]="'style_' + tag">
              {{ GmStyleTagLabels[tag] }}
            </label>
          </div>
          }
        </div>
      </div>

      <div class="form-group text-start">
        <label for="notes">Notatki</label>
        <textarea
          id="notes"
          class="form-control"
          formControlName="notes"
        ></textarea>
      </div>

      <div class="form-group form-check">
        <input
          id="isOpen"
          class="form-check-input"
          type="checkbox"
          formControlName="isOpen"
        />
        <label class="form-check-label" for="isOpen">
          Dostępna dla innych
        </label>
      </div>

      <button type="submit" class="btn btn-primary mt-3">
        {{ createButtonText() }}
      </button>
    </form>
  </div>

  <ng-template #partySuccessToast>
    <strong>Sukces!</strong> Drużyna została {{ modeSuccessMessage }}.
  </ng-template>

  <ng-template #partyErrorToast>
    <strong>Błąd!</strong> Nie udało się {{ modeFailMessage }} drużyny.
  </ng-template>
</div>
