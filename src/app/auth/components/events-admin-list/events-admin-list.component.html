<div class="events-admin-list full-height">
  <div class="container">
    <h2 class="section-title mb-3">Poprowadź wydarzenie</h2>

    @if (visibleEvents().length) {

      <!-- pasek chipów tylko z widocznymi eventami -->
      <div class="events-tabs" role="tablist" aria-label="Lista eventów">
        @for (e of visibleEvents(); track e.id) {
          <button
            type="button"
            class="btn btn-outline btn-sm"
            role="tab"
            [attr.aria-selected]="selected()?.slug === e.slug"
            [class.active]="selected()?.slug === e.slug"
            (click)="pickEvent(e.slug)"
            [title]="e.name">
            {{ e.name }}
          </button>
        }
      </div>

      <!-- panel szczegółów wybranego eventu -->
      @let ev = selected();
      @if (ev) {
        <section class="card card-dark card-body event-details event-card">
          <header class="header">
            <div class="title">
              <h3 class="golden">{{ ev.name }}</h3>
              <div class="tags">
                @if (ev.isForBeginners) {
                  <span class="tag-badge green me-1">Dla początkujących</span>
                }
                @if (ev.attractionType) {
                  <span class="tag-badge club me-1">{{ getAttractionLabel(ev.attractionType) }}</span>
                }
              </div>
            </div>
            <div class="actions">
              <button type="button" class="btn btn-primary" (click)="goEdit()">Edytuj</button>
            </div>
          </header>

          <div class="meta">
            <div><dt>Godziny</dt><dd>{{ ev.startTime.slice(0,5) }}–{{ ev.endTime.slice(0,5) }}</dd></div>
            <div><dt>Salki</dt><dd>{{ (ev.rooms || []).join(', ') || '—' }}</dd></div>
            <div><dt>Typ</dt><dd>{{ AttractionKindLabel[ev.attractionType] }}</dd></div>
          </div>

          @if (ev.shortDescription) {
            <p class="desc">{{ ev.shortDescription }}</p>
          }

          <!-- JEDNORAZOWE PROSTE: data -->
          @if (ev.singleDate && !isComposite(ev)) {
            <div class="dates">
              <h4 class="h6">Termin</h4>
              <div>
                <button
                  type="button"
                  class="btn btn-sm"
                  [class.btn-outline]="!(ev && isFull(ev.id, ev.singleDate))"
                  [class.btn-danger]="ev && isFull(ev.id, ev.singleDate)"
                  [disabled]="!(ev && canClick(ev, ev.singleDate))"
                  [attr.aria-disabled]="!(ev && canClick(ev, ev.singleDate)) || null"
                  (click)="ev && canClick(ev, ev.singleDate) ? goSignup(ev.singleDate) : null"
                  [title]="!(ev && canClick(ev, ev.singleDate)) ? 'Komplet — brak miejsc' : null">
                  {{ ev.singleDate }}
                </button>
              </div>
            </div>

          <!-- JEDNORAZOWE ZŁOŻONE (Composite): lista salek -->
      } @else if (isComposite(ev)) {
        <div class="occ">
          <h4 class="h6">Zgłoszenia per salkę</h4>

          @if (ev.roomPlans?.length) {
            <div class="rooms-grid">
              @for (plan of ev.roomPlans; track plan.roomName) {
                @let slots = slotsForRoom(ev, plan);

                <div class="room-tile card-like p-2">
                  <div class="room-head">
                    <strong class="me-2">{{ plan.roomName }}</strong>
                    <span class="tag-badge gray">
                      {{ roomGranularityLabel(ev, plan) }}
                    </span>
                  </div>

                  <!-- BRAK ZGŁOSZEŃ DLA TEJ SALI -->
                  @if (!slots.length) {
                    <div class="muted mt-2">
                      Do tej salki nie są wymagane zgłoszenia prowadzących.
                    </div>
                  } @else {
                    @let schedule = plan.scheduleKind ?? RoomScheduleKind.FullSpan;

                    <!-- CAŁY PRZEDZIAŁ (jeden przycisk) -->
                    @if (schedule === RoomScheduleKind.FullSpan && slots.length === 1) {
                      <div class="room-actions mt-2">
                        <button
                          type="button"
                          class="btn btn-sm"
                          [class.btn-outline]="roomStatus(ev.id, ev.singleDate!, plan.roomName) === 'free'"
                          [class.btn-danger]="roomStatus(ev.id, ev.singleDate!, plan.roomName) !== 'free'"
                          [disabled]="roomStatus(ev.id, ev.singleDate!, plan.roomName) === 'taken'"
                          (click)="roomStatus(ev.id, ev.singleDate!, plan.roomName) !== 'taken'
                            ? goSignupRoom(plan.roomName, ev.singleDate!)
                            : null">
                          Zgłoś się
                        </button>
                      </div>
                    } @else {
                      <!-- WIELE SLOTÓW (przyciski HH:mm–HH:mm) -->
                      <div class="dates mt-2">
                        @for (s of slots; track s.startTime) {
                          <button
                            type="button"
                            class="btn btn-sm"
                            [class.btn-outline]="slotStatus(ev.id, ev.singleDate!, plan.roomName, s.startTime) === 'free'"
                            [class.btn-danger]="slotStatus(ev.id, ev.singleDate!, plan.roomName, s.startTime) !== 'free'"
                            [disabled]="slotStatus(ev.id, ev.singleDate!, plan.roomName, s.startTime) === 'taken'"
                            (click)="slotStatus(ev.id, ev.singleDate!, plan.roomName, s.startTime) !== 'taken'
                              ? goSignupRoom(plan.roomName, ev.singleDate!, s.startTime, s.endTime)
                              : null">
                            {{ s.startTime.slice(0,5) }}–{{ s.endTime.slice(0,5) }}
                          </button>
                        }
                      </div>
                    }
                  }
                </div>
              }
            </div>

            @let leftovers = roomsWithoutPlan(ev);
            @if (leftovers.length) {
              <div class="muted mt-3">
                Brak zdefiniowanych planów zapisów dla salek:
                {{ leftovers.join(', ') }}.
              </div>
            }
          } @else {
            <div class="muted">Brak zdefiniowanych planów salek.</div>
          }
        </div>

          <!-- CYKLICZNE: jak dotąd -->
          } @else {
            <div class="occ">
              <h4 class="h6">Zgłoszenie prowadzących</h4>

              <div class="month-block">
                <div class="month-title">Bieżący miesiąc</div>
                @if (occurrencesThisMonth().length) {
                  <div class="dates">
                    @for (d of occurrencesThisMonth(); track $index) {
                      <button
                        type="button"
                        class="btn btn-sm"
                        [class.btn-outline]="!(ev && isFull(ev.id, d))"
                        [class.btn-danger]="ev && isFull(ev.id, d)"
                        [disabled]="!(ev && canClick(ev, d))"
                        [attr.aria-disabled]="!(ev && canClick(ev, d)) || null"
                        (click)="ev && canClick(ev, d) ? goSignup(d) : null"
                        [title]="!(ev && canClick(ev, d)) ? 'Komplet — brak miejsc' : null">
                        {{ d }}
                      </button>
                    }
                  </div>
                } @else {
                  <div class="muted">Brak terminów.</div>
                }
              </div>

              <div class="month-block">
                <div class="month-title">Przyszły miesiąc</div>
                @if (occurrencesNextMonth().length) {
                  <div class="dates">
                    @for (d of occurrencesNextMonth(); track $index) {
                      <button
                        type="button"
                        class="btn btn-sm"
                        [class.btn-outline]="!(ev && isFull(ev.id, d))"
                        [class.btn-danger]="ev && isFull(ev.id, d)"
                        [disabled]="!(ev && canClick(ev, d))"
                        [attr.aria-disabled]="!(ev && canClick(ev, d)) || null"
                        (click)="ev && canClick(ev, d) ? goSignup(d) : null"
                        [title]="!(ev && canClick(ev, d)) ? 'Komplet — brak miejsc' : null">
                        {{ d }}
                      </button>
                    }
                  </div>
                } @else {
                  <div class="muted">Brak terminów.</div>
                }
              </div>
            </div>
          }
        </section>
      }

    } @else {
      <p class="muted">Brak wydarzeń dostępnych dla Twoich uprawnień.</p>
    }
  </div>
</div>
