<div class="event-form-panel full-height">
  <div class="container">
    <h2 class="section-title">{{ title() }}</h2>

    <form [formGroup]="form" (ngSubmit)="submit()" class="user-info-form">
      @if (coverPreviewUrl() || coverCdnUrl()) {
      <div class="form-group">
        <img
          class="cover-preview"
          [src]="coverPreviewUrl() || coverCdnUrl() || ''"
          alt="Okładka"
        />
      </div>
      }

      <div class="form-group">
        <label class="text-start">Nazwa</label>
        <input type="text" class="form-control" formControlName="name" />
      </div>

      <div class="form-group">
        <label class="text-start">Slug</label>
        <input type="text" class="form-control" formControlName="slug" />
        <div class="form-text">
          Slug generowany automatycznie na podstawie nazwy.
        </div>
      </div>

      <div class="form-group">
        <label class="text-start">Okładka</label>
        <div class="row-inline cover-row">
          <input
            type="file"
            class="form-control"
            (change)="onCoverChange($event)"
          />
          <button
            type="button"
            class="btn btn-outline-danger w-auto"
            (click)="removeCover()
            "
            [disabled]="!coverPreviewUrl() && !form.value.coverImagePath"
          >
            Usuń okładkę
          </button>
        </div>
      </div>

      <div class="form-group">
        <label class="text-start">Opis krótki</label>
        <input
          type="text"
          class="form-control"
          formControlName="shortDescription"
        />
      </div>

      <div class="form-group">
        <label class="text-start">Opis długi</label>
        <textarea
          rows="6"
          class="form-control"
          formControlName="longDescription"
        ></textarea>
      </div>

      <div class="form-group">
        <label class="text-start">Salki</label>
        <div class="chips">
          @for (r of roomsList; track r) {
          <label class="chip">
            <input
              type="checkbox"
              [checked]="form.value.rooms?.includes(r)"
              (change)="onToggleRoom(r, $event)"
            />
            {{ r }}
          </label>
          }
        </div>
      </div>

      <div class="form-group flags-row">
        <div class="form-check">
          <input
            id="isActive"
            class="form-check-input"
            type="checkbox"
            formControlName="isActive"
          />
          <label class="form-check-label" for="isActive">Aktywny</label>
        </div>

        <div class="form-check">
          <input
            id="isBeg"
            class="form-check-input"
            type="checkbox"
            formControlName="isForBeginners"
          />
          <label class="form-check-label" for="isBeg">Dla początkujących</label>
        </div>

        <div class="form-check">
          <input
            id="reqHosts"
            class="form-check-input"
            type="checkbox"
            formControlName="requiresHosts"
          />
          <label class="form-check-label" for="reqHosts"
            >Wymaga prowadzących</label
          >
        </div>

        <div
          class="form-check"
          [ngbTooltip]="
            'Gdy odznaczone – salki blokujemy dopiero po zgłoszeniu prowadzącego.'
          "
          placement="top"
          container="body"
        >
          <input
            id="blockSlots"
            class="form-check-input"
            type="checkbox"
            formControlName="blockSlots"
          />
          <label class="form-check-label" for="blockSlots"
            >Zablokuj terminy od razu</label
          >
        </div>
      </div>

      <div class="form-group">
        <label class="text-start">Koszt uczestnictwa (PLN)</label>
        <input
          type="number"
          class="form-control"
          formControlName="entryFeePln"
          min="0"
          step="1"
        />
      </div>

            <div class="form-group">
        <label class="text-start">Tryb wystąpień</label>
        <div class="btn-group" role="group" aria-label="Tryb wystąpień">
          <input
            type="radio"
            class="btn-check"
            id="occ-single"
            [checked]="form.value.occurrenceMode==='SINGLE'"
            (change)="f.occurrenceMode.setValue('SINGLE')"
          />
          <label class="btn btn-outline-primary" for="occ-single">Jednorazowe</label>

          <input
            type="radio"
            class="btn-check"
            id="occ-recurrent"
            [checked]="form.value.occurrenceMode==='RECURRENT'"
            (change)="f.occurrenceMode.setValue('RECURRENT')"
          />
          <label class="btn btn-outline-primary" for="occ-recurrent">Cykliczne</label>
        </div>
        <div class="form-text">
          Wydarzenie <strong>złożone</strong> (plany salek) dostępne tylko dla trybu <em>Jednorazowe</em>.
        </div>
      </div>

      <div class="form-group row-inline">
        <div>
          <label class="text-start">Typ wydarzenia</label>
          <div ngbDropdown class="d-block">
            <button
              type="button"
              class="btn btn-outline dropdown-toggle dropdown-toggle-wide"
              ngbDropdownToggle
            >
              {{ attractionLabel() }}
            </button>
            <div ngbDropdownMenu class="dropdown-pane">
              <button
                type="button"
                class="dropdown-item"
                [class.active]="
                  form.value.attractionType === AttractionKind.Session
                "
                (click)="f.attractionType.setValue(AttractionKind.Session)"
              >
                {{ AttractionKindLabel[AttractionKind.Session] }}
              </button>
              <button
                type="button"
                class="dropdown-item"
                [class.active]="
                  form.value.attractionType === AttractionKind.Discussion
                "
                (click)="f.attractionType.setValue(AttractionKind.Discussion)"
              >
                {{ AttractionKindLabel[AttractionKind.Discussion] }}
              </button>
              <button
                type="button"
                class="dropdown-item"
                [class.active]="
                  form.value.attractionType === AttractionKind.Entertainment
                "
                (click)="
                  f.attractionType.setValue(AttractionKind.Entertainment)
                "
              >
                {{ AttractionKindLabel[AttractionKind.Entertainment] }}
              </button>

              @if (form.value.occurrenceMode==='SINGLE') {
              <div class="dropdown-divider"></div>
              <button
                type="button"
                class="dropdown-item"
                [class.active]="
                  form.value.attractionType === AttractionKind.Composite
                "
                (click)="f.attractionType.setValue(AttractionKind.Composite)"
              >
                {{ AttractionKindLabel[AttractionKind.Composite] }}
              </button>
              }
            </div>
          </div>
        </div>

        @if (form.value.requiresHosts && !(form.value.occurrenceMode==='SINGLE'
        && form.value.attractionType===AttractionKind.Composite)) {
        <div>
          <label class="text-start">Kto może być prowadzącym</label>
          <div ngbDropdown class="d-block">
            <button
              type="button"
              class="btn btn-outline dropdown-toggle dropdown-toggle-wide"
              ngbDropdownToggle
            >
              {{ hostSignupLabel() }}
            </button>
            <div ngbDropdownMenu class="dropdown-pane">
              <button
                type="button"
                class="dropdown-item"
                [class.active]="form.value.hostSignup === HostSignupScope.Staff"
                (click)="f.hostSignup.setValue(HostSignupScope.Staff)"
              >
                {{ HostSignupScopeLabel[HostSignupScope.Staff] }}
              </button>
              <button
                type="button"
                class="dropdown-item"
                [class.active]="form.value.hostSignup === HostSignupScope.Any"
                (click)="f.hostSignup.setValue(HostSignupScope.Any)"
              >
                {{ HostSignupScopeLabel[HostSignupScope.Any] }}
              </button>
            </div>
          </div>
        </div>
        }

        <div>
          <label class="text-start">Zakres zapisów</label>
          <div ngbDropdown class="d-block">
            <button
              type="button"
              class="btn btn-outline dropdown-toggle dropdown-toggle-wide"
              ngbDropdownToggle
            >
              {{ participantSignupLabel() }}
            </button>
            <div ngbDropdownMenu class="dropdown-pane">
              <button
                type="button"
                class="dropdown-item"
                [class.active]="
                  form.value.participantSignup === ParticipantSignupScope.None
                "
                (click)="
                  f.participantSignup.setValue(ParticipantSignupScope.None)
                "
              >
                Brak zapisów
              </button>
              <button
                type="button"
                class="dropdown-item"
                [class.active]="
                  form.value.participantSignup === ParticipantSignupScope.Whole
                "
                (click)="
                  f.participantSignup.setValue(ParticipantSignupScope.Whole)
                "
              >
                Na całe wydarzenie (bez slotów)
              </button>
              <button
                type="button"
                class="dropdown-item"
                [class.active]="
                  form.value.participantSignup ===
                  ParticipantSignupScope.Session
                "
                (click)="
                  f.participantSignup.setValue(ParticipantSignupScope.Session)
                "
              >
                Tylko na sloty
              </button>
              <button
                type="button"
                class="dropdown-item"
                [class.active]="
                  form.value.participantSignup === ParticipantSignupScope.Both
                "
                (click)="
                  f.participantSignup.setValue(ParticipantSignupScope.Both)
                "
              >
                Na wydarzenie i na sloty
              </button>
            </div>
          </div>
        </div>
      </div>

      @if (form.value.participantSignup === ParticipantSignupScope.Whole ||
      form.value.participantSignup === ParticipantSignupScope.Both) {
      <div class="form-group">
        <label class="text-start">Limit na wydarzenie (0 = bez limitu)</label>
        <input
          type="number"
          class="form-control"
          formControlName="wholeCapacity"
          min="0"
          step="1"
        />
      </div>
      } @if ((form.value.participantSignup === ParticipantSignupScope.Session ||
      form.value.participantSignup === ParticipantSignupScope.Both) &&
      form.value.attractionType === AttractionKind.Session) {
      <div class="form-group">
        <label class="text-start">Domyślny limit na slot (3–5)</label>
        <input
          type="number"
          class="form-control"
          formControlName="sessionCapacity"
          min="3"
          max="5"
          step="1"
        />
        <div class="form-text">Dotyczy tylko atrakcji typu „Sesja”.</div>
      </div>
      } @if (form.value.occurrenceMode==='SINGLE') {
      <div class="form-group">
        <label class="text-start">Data</label>
        <input type="date" class="form-control" formControlName="singleDate" />
      </div>
      } @else {
      <div class="form-group">
        <label class="text-start">Data startu cyklu</label>
        <input type="date" class="form-control" formControlName="startDate" />
      </div>
      }

      <div class="form-group row-inline">
        <div>
          <label class="text-start">Godzina rozpoczęcia</label>
          <input type="time" class="form-control" formControlName="startTime" />
        </div>
        <div>
          <label class="text-start">Godzina zakończenia</label>
          <input type="time" class="form-control" formControlName="endTime" />
        </div>
      </div>

      @if (form.value.occurrenceMode==='RECURRENT') {
      <div class="form-group">
        <label class="text-start">Powtarzanie</label>
        <div ngbDropdown class="d-block">
          <button
            type="button"
            class="btn btn-outline dropdown-toggle dropdown-toggle-wide"
            ngbDropdownToggle
          >
            {{ patternLabel() }}
          </button>
          <div ngbDropdownMenu class="dropdown-pane">
            @for (o of patternOptions; track o.value) {
            <button
              type="button"
              class="dropdown-item"
              [class.active]="form.value.recPattern === o.value"
              (click)="f.recPattern.setValue(o.value)"
            >
              {{ o.label }}
            </button>
            }
          </div>
        </div>
      </div>

      @if (form.value.recPattern==='WEEKLY_1' ||
      form.value.recPattern==='WEEKLY_2') {
      <div class="form-group row-inline">
        <div>
          <label class="text-start">Dzień tygodnia</label>
          <div ngbDropdown class="d-block">
            <button
              type="button"
              class="btn btn-outline dropdown-toggle dropdown-toggle-wide"
              ngbDropdownToggle
            >
              {{ weekdayLabel() }}
            </button>
            <div ngbDropdownMenu class="dropdown-pane">
              @for (w of weekdays; track w.value) {
              <button
                type="button"
                class="dropdown-item"
                [class.active]="form.value.weekday === w.value"
                (click)="f.weekday.setValue(w.value)"
              >
                {{ w.label }}
              </button>
              }
            </div>
          </div>
        </div>

        <div>
          <label class="text-start">Wykluczenia w miesiącu</label>
          <div ngbDropdown class="d-block">
            <button
              type="button"
              class="btn btn-outline dropdown-toggle dropdown-toggle-wide"
              ngbDropdownToggle
            >
              {{ excludeNthLongLabel() }}
            </button>
            <div ngbDropdownMenu class="dropdown-pane">
              @for (o of excludeNthOptions; track o.value) {
              <button
                type="button"
                class="dropdown-item"
                [class.active]="form.value.excludeNth === o.value"
                (click)="f.excludeNth.setValue(o.value)"
              >
                {{ excludeNthLongLabelFor(o.value) }}
              </button>
              }
            </div>
          </div>
        </div>
      </div>
      } @if (form.value.recPattern==='MONTHLY_NTH') {
      <div class="form-group row-inline">
        <div>
          <label class="text-start">Który</label>
          <div ngbDropdown class="d-block">
            <button
              type="button"
              class="btn btn-outline dropdown-toggle dropdown-toggle-wide"
              ngbDropdownToggle
            >
              {{ monthlyNthLabel() }}
            </button>
            <div ngbDropdownMenu class="dropdown-pane">
              @for (o of monthlyNthOptions; track o.value) {
              <button
                type="button"
                class="dropdown-item"
                [class.active]="form.value.monthlyNth === o.value"
                (click)="f.monthlyNth.setValue(o.value)"
              >
                {{ o.label }}
              </button>
              }
            </div>
          </div>
        </div>
        <div>
          <label class="text-start">Dzień tygodnia</label>
          <div ngbDropdown class="d-block">
            <button
              type="button"
              class="btn btn-outline dropdown-toggle dropdown-toggle-wide"
              ngbDropdownToggle
            >
              {{ monthlyWeekdayLabel() }}
            </button>
            <div ngbDropdownMenu class="dropdown-pane">
              @for (w of weekdays; track w.value) {
              <button
                type="button"
                class="dropdown-item"
                [class.active]="form.value.monthlyWeekday === w.value"
                (click)="f.monthlyWeekday.setValue(w.value)"
              >
                {{ w.label }}
              </button>
              }
            </div>
          </div>
        </div>
      </div>
      } @if (form.value.recPattern==='MONTHLY_DOM') {
      <div class="form-group">
        <label class="text-start">Dzień miesiąca</label>
        <input
          type="number"
          min="1"
          max="31"
          class="form-control"
          formControlName="dayOfMonth"
        />
      </div>
      }

      <div class="form-group">
        <label class="text-start">Koniec cyklu</label>
        <input type="date" class="form-control" formControlName="endDate" />
      </div>
      } @if (form.value.occurrenceMode==='SINGLE' &&
      form.value.attractionType===AttractionKind.Composite) {
      <div class="form-group">
        <label class="text-start">Plany salek (złożone)</label>

        @for (r of form.value.rooms || []; track r) {
        <div class="card card-dark admin-preview mb-3 p-3">
          <h5 class="mb-2">{{ r }}</h5>

          <div>
            <div ngbDropdown class="d-block me-2">
              <button
                type="button"
                class="btn btn-outline dropdown-toggle"
                ngbDropdownToggle
              >
                {{ purposeLabel(roomPlans()[r].purpose) }}
              </button>
              <div ngbDropdownMenu class="dropdown-pane">
                <button
                  type="button"
                  class="dropdown-item"
                  [class.active]="
                    roomPlans()[r].purpose === RoomPurpose.Session
                  "
                  (click)="setRoomPurpose(r, RoomPurpose.Session)"
                >
                  {{ RoomPurposeLabel[RoomPurpose.Session] }}
                </button>
                <button
                  type="button"
                  class="dropdown-item"
                  [class.active]="
                    roomPlans()[r].purpose === RoomPurpose.Discussion
                  "
                  (click)="setRoomPurpose(r, RoomPurpose.Discussion)"
                >
                  {{ RoomPurposeLabel[RoomPurpose.Discussion] }}
                </button>
                <button
                  type="button"
                  class="dropdown-item"
                  [class.active]="
                    roomPlans()[r].purpose === RoomPurpose.Entertainment
                  "
                  (click)="setRoomPurpose(r, RoomPurpose.Entertainment)"
                >
                  {{ RoomPurposeLabel[RoomPurpose.Entertainment] }}
                </button>
                <button
                  type="button"
                  class="dropdown-item"
                  [class.active]="roomPlans()[r].purpose === RoomPurpose.None"
                  (click)="setRoomPurpose(r, RoomPurpose.None)"
                >
                  {{ RoomPurposeLabel[RoomPurpose.None] }}
                </button>
              </div>
            </div>
          </div>

          <div class="mt-2">
            <div>
              <input
                #titleInput
                type="text"
                class="form-control"
                [placeholder]="
                  roomPlans()[r].purpose === RoomPurpose.Entertainment
                    ? 'Szczegóły rozrywki (wymagane)'
                    : 'Tytuł (opcjonalnie)'
                "
                [value]="roomPlans()[r].customTitle || ''"
                (input)="setRoomTitle(r, titleInput.value)"
              />
              @if (roomPlans()[r].purpose===RoomPurpose.Entertainment &&
              !(roomPlans()[r].customTitle || '').trim()) {
              <div class="form-text font-size-small text-danger mt-1">
                Podaj, co to za rozrywka (np. turniej, Magic, Munchkin…)
              </div>
              }
            </div>
          </div>

          <div class="mt-3">
            <div class="btn-group">
              <input
                type="radio"
                class="btn-check"
                [id]="'sch-full-' + r"
                [checked]="
                  roomPlans()[r].scheduleKind === RoomScheduleKind.FullSpan
                "
                (change)="pickSchedule(r, RoomScheduleKind.FullSpan)"
              />
              <label class="btn btn-outline-primary" [for]="'sch-full-' + r"
                >Cały przedział</label
              >

              <input
                type="radio"
                class="btn-check"
                [id]="'sch-int-' + r"
                [checked]="
                  roomPlans()[r].scheduleKind === RoomScheduleKind.Interval
                "
                (change)="pickSchedule(r, RoomScheduleKind.Interval)"
              />
              <label class="btn btn-outline-primary" [for]="'sch-int-' + r"
                >Co X godzin</label
              >

              <input
                type="radio"
                class="btn-check"
                [id]="'sch-sch-' + r"
                [checked]="
                  roomPlans()[r].scheduleKind === RoomScheduleKind.Schedule
                "
                (change)="pickSchedule(r, RoomScheduleKind.Schedule)"
              />
              <label class="btn btn-outline-primary" [for]="'sch-sch-' + r"
                >Ręcznie</label
              >
            </div>
            <div class="form-text">
              Poziom prowadzących:
              <strong>{{
                roomPlans()[r].scheduleKind === RoomScheduleKind.Schedule ? 'SLOT' : 'ROOM'
              }}</strong>
            </div>
          </div>

          <div class="mt-3">
            <div class="form-check">
              <input
                #roomReq
                [id]="'rh-' + r"
                class="form-check-input"
                type="checkbox"
                [checked]="roomPlans()[r].requiresHosts"
                (change)="setRoomRequiresHosts(r, roomReq.checked)"
              />
              <label class="form-check-label" [for]="'rh-' + r"
                >Ta salka wymaga prowadzących</label
              >
            </div>

            @if (roomPlans()[r].requiresHosts &&
            (roomPlans()[r].scheduleKind===RoomScheduleKind.FullSpan ||
            roomPlans()[r].scheduleKind===RoomScheduleKind.Interval)) {
            <div class="mt-2">
              <label class="text-start"
                >Kto może być prowadzącym (ta salka)</label
              >
              <div ngbDropdown class="d-block">
                <button
                  type="button"
                  class="btn btn-outline dropdown-toggle"
                  ngbDropdownToggle
                >
                  {{
                    roomPlans()[r].hostScope === HostSignupScope.Any
                      ? HostSignupScopeLabel[HostSignupScope.Any]
                      : HostSignupScopeLabel[HostSignupScope.Staff]
                  }}
                </button>
                <div ngbDropdownMenu class="dropdown-pane">
                  <button
                    type="button"
                    class="dropdown-item"
                    [class.active]="
                      roomPlans()[r].hostScope === HostSignupScope.Staff
                    "
                    (click)="setRoomHostScope(r, HostSignupScope.Staff)"
                  >
                    {{ HostSignupScopeLabel[HostSignupScope.Staff] }}
                  </button>
                  <button
                    type="button"
                    class="dropdown-item"
                    [class.active]="
                      roomPlans()[r].hostScope === HostSignupScope.Any
                    "
                    (click)="setRoomHostScope(r, HostSignupScope.Any)"
                  >
                    {{ HostSignupScopeLabel[HostSignupScope.Any] }}
                  </button>
                </div>
              </div>
            </div>
            } @if (roomPlans()[r].requiresHosts &&
            roomPlans()[r].scheduleKind===RoomScheduleKind.Schedule) {
            <div class="mt-2 form-check">
              <input
                id="allSlotsHost-{{ r }}"
                class="form-check-input"
                type="checkbox"
                [checked]="roomPlans()[r].allSlotsRequireHosts === true"
                (change)="onAllSlotsRequireHostsChange(r, $event)"
              />
              <label class="form-check-label" for="allSlotsHost-{{ r }}">
                Wszystkie sloty wymagają prowadzącego
              </label>
            </div>
            }
          </div>

          <div class="mt-3">
            <div class="form-check">
              <input
                #roomReqPart
                [id]="'rp-' + r"
                class="form-check-input"
                type="checkbox"
                [disabled]="isWholeSignups() || isNoneSignups()"
                [checked]="roomPlans()[r].requiresParticipants === true"
                (change)="setRoomRequiresParticipants(r, roomReqPart.checked)"
              />
              <label class="form-check-label" [for]="'rp-' + r">
                Ta salka ma zapisy uczestników (na sloty)
              </label>
            </div>

            @if (isWholeSignups()) {
            <div class="form-text">
              Wybrano „Na całe wydarzenie” – zapisy na sloty są wyłączone.
            </div>
            } @if (isNoneSignups()) {
            <div class="form-text">
              Wybrano „Brak zapisów” – zapisy na sloty są wyłączone.
            </div>
            } @if (roomPlans()[r].requiresParticipants &&
            !isWholeSignups() && !isNoneSignups() &&
            (roomPlans()[r].scheduleKind===RoomScheduleKind.FullSpan ||
            roomPlans()[r].scheduleKind===RoomScheduleKind.Interval)) {
            <div class="row-inline mt-2">
              <div>
                <label class="text-start">
                  Limit na slot
                  <span class="text-muted">
                    ({{ roomPlans()[r].purpose===RoomPurpose.Session ? '3–5' : '0 = bez limitu' }})
                  </span>
                </label>
                <input
                  #roomCap
                  type="number"
                  class="form-control w-auto"
                  [min]="roomPlans()[r].purpose===RoomPurpose.Session ? 3 : 0"
                  [attr.max]="roomPlans()[r].purpose===RoomPurpose.Session ? 5 : null"
                  step="1"
                  [value]="
                    roomPlans()[r].sessionCapacity ??
                    (roomPlans()[r].purpose===RoomPurpose.Session
                      ? (form.value.sessionCapacity ?? 5)
                      : 0)
                  "
                  (input)="setRoomSessionCapacity(r, roomCap.value)"
                />
              </div>
            </div>

            @if (roomPlans()[r].scheduleKind===RoomScheduleKind.Interval) {
            <div class="form-text mt-1">
              Ustawienia dotyczą każdego interwału w tej salce.
            </div>
            } }
          </div>

          @if (roomPlans()[r].scheduleKind===RoomScheduleKind.Interval) {
          <div class="row-inline mt-3">
            <label class="text-start me-2">Długość slotu (h)</label>
            <input
              #ih
              type="number"
              min="1"
              step="1"
              class="form-control w-auto"
              [value]="roomPlans()[r].intervalHours ?? 1"
              (input)="setIntervalHours(r, ih.value)"
            />
          </div>
          <div>
            <div class="form-text">
              Sloty będą dzielić cały przedział od „Godzina rozpoczęcia” do
              „Godzina zakończenia”.
            </div>
          </div>
          } @if (roomPlans()[r].scheduleKind===RoomScheduleKind.Schedule) {
          <div class="mt-3">
            @for (s of roomPlans()[r].slots || []; let i = $index; track i) {
            <div class="card-like p-2 mb-2">
              <div class="row-inline mb-2">
                <input
                  #st
                  type="time"
                  class="form-control w-auto"
                  [value]="s.startTime"
                  (input)="updateSlot(r, i, { startTime: st.value })"
                />
                <span>&nbsp;–&nbsp;</span>
                <input
                  #en
                  type="time"
                  class="form-control w-auto"
                  [value]="s.endTime"
                  (input)="updateSlot(r, i, { endTime: en.value })"
                />

                <div ngbDropdown class="d-block ms-2">
                  <button
                    type="button"
                    class="btn btn-outline dropdown-toggle"
                    ngbDropdownToggle
                  >
                    {{
                      RoomPurposeLabel[
                        s.purpose || roomPlans()[r].purpose || RoomPurpose.None
                      ]
                    }}
                  </button>
                  <div ngbDropdownMenu class="dropdown-pane">
                    <button
                      type="button"
                      class="dropdown-item"
                      [class.active]="
                        (s.purpose || roomPlans()[r].purpose) ===
                        RoomPurpose.Session
                      "
                      (click)="
                        updateSlot(r, i, { purpose: RoomPurpose.Session })
                      "
                    >
                      {{ RoomPurposeLabel[RoomPurpose.Session] }}
                    </button>
                    <button
                      type="button"
                      class="dropdown-item"
                      [class.active]="
                        (s.purpose || roomPlans()[r].purpose) ===
                        RoomPurpose.Discussion
                      "
                      (click)="
                        updateSlot(r, i, { purpose: RoomPurpose.Discussion })
                      "
                    >
                      {{ RoomPurposeLabel[RoomPurpose.Discussion] }}
                    </button>
                    <button
                      type="button"
                      class="dropdown-item"
                      [class.active]="
                        (s.purpose || roomPlans()[r].purpose) ===
                        RoomPurpose.Entertainment
                      "
                      (click)="
                        updateSlot(r, i, { purpose: RoomPurpose.Entertainment })
                      "
                    >
                      {{ RoomPurposeLabel[RoomPurpose.Entertainment] }}
                    </button>
                    <button
                      type="button"
                      class="dropdown-item"
                      [class.active]="
                        (s.purpose || roomPlans()[r].purpose) ===
                        RoomPurpose.None
                      "
                      (click)="updateSlot(r, i, { purpose: RoomPurpose.None })"
                    >
                      {{ RoomPurposeLabel[RoomPurpose.None] }}
                    </button>
                  </div>
                </div>
              </div>

              <div class="row-inline">
                <div class="form-check me-3">
                  <input
                    #slotReq
                    [id]="'slrh-' + r + '-' + i"
                    class="form-check-input"
                    type="checkbox"
                    [checked]="s.requiresHosts !== false"
                    (change)="
                      updateSlot(r, i, { requiresHosts: slotReq.checked })
                    "
                  />
                  <label class="form-check-label" [for]="'slrh-' + r + '-' + i"
                    >Slot wymaga prowadzącego</label
                  >
                </div>

                @if (s.requiresHosts !== false) {
                <div>
                  <label class="text-start"
                    >Kto może być prowadzącym (slot)</label
                  >
                  <div ngbDropdown class="d-block">
                    <button
                      type="button"
                      class="btn btn-outline dropdown-toggle"
                      ngbDropdownToggle
                    >
                      {{
                        (s.hostScope ?? HostSignupScope.Staff) ===
                        HostSignupScope.Any
                          ? HostSignupScopeLabel[HostSignupScope.Any]
                          : HostSignupScopeLabel[HostSignupScope.Staff]
                      }}
                    </button>
                    <div ngbDropdownMenu class="dropdown-pane">
                      <button
                        type="button"
                        class="dropdown-item"
                        [class.active]="
                          (s.hostScope ?? HostSignupScope.Staff) ===
                          HostSignupScope.Staff
                        "
                        (click)="
                          updateSlot(r, i, { hostScope: HostSignupScope.Staff })
                        "
                      >
                        {{ HostSignupScopeLabel[HostSignupScope.Staff] }}
                      </button>
                      <button
                        type="button"
                        class="dropdown-item"
                        [class.active]="s.hostScope === HostSignupScope.Any"
                        (click)="
                          updateSlot(r, i, { hostScope: HostSignupScope.Any })
                        "
                      >
                        {{ HostSignupScopeLabel[HostSignupScope.Any] }}
                      </button>
                    </div>
                  </div>
                </div>
                }
              </div>

              <div class="row-inline mt-2">
                <div class="form-check me-3">
                  <input
                    #slotReqPart
                    [id]="'slrp-' + r + '-' + i"
                    class="form-check-input"
                    type="checkbox"
                    [disabled]="isWholeSignups() || isNoneSignups()"
                    [checked]="effectiveSlotRequiresParticipants(r, s)"
                    (change)="
                      updateSlot(r, i, {
                        requiresParticipants: slotReqPart.checked
                      })
                    "
                  />
                  <label class="form-check-label" [for]="'slrp-' + r + '-' + i"
                    >Slot ma zapisy uczestników</label
                  >
                </div>

                @if (isWholeSignups()) {
                <div class="form-text">
                  Wybrano „Na całe wydarzenie” – zapisy na sloty są wyłączone.
                </div>
                } @if (isNoneSignups()) {
                <div class="form-text">
                  Wybrano „Brak zapisów” – zapisy na sloty są wyłączone.
                </div>
                } @if (effectiveSlotRequiresParticipants(r, s) &&
                !isWholeSignups() && !isNoneSignups()) {
                <div class="row-inline">
                  <div>
                    <label class="text-start">
                      Limit na ten slot
                      <span class="text-muted">
                        {{
                          (s.purpose || roomPlans()[r].purpose)===RoomPurpose.Session
                            ? '(3–5)'
                            : '(≥ 0; 0 = bez limitu)'
                        }}
                      </span>
                    </label>
                    <input
                      #slotCap
                      type="number"
                      class="form-control w-auto"
                      [min]="(s.purpose || roomPlans()[r].purpose)===RoomPurpose.Session ? 3 : 0"
                      [attr.max]="(s.purpose || roomPlans()[r].purpose)===RoomPurpose.Session ? 5 : null"
                      step="1"
                      [value]="effectiveSlotCapacity(r, s)"
                      (input)="
                        updateSlot(r, i, {
                          sessionCapacity: Number(slotCap.value)
                        })
                      "
                    />
                  </div>
                </div>
                }
              </div>

              <div class="row-inline mt-2">
                <input
                  #slotTitle
                  type="text"
                  class="form-control w-100"
                  [placeholder]="
                    (s.purpose || roomPlans()[r].purpose) ===
                    RoomPurpose.Entertainment
                      ? 'Szczegóły rozrywki (wymagane)'
                      : 'Tytuł (opcjonalnie)'
                  "
                  [value]="s.customTitle || ''"
                  (input)="
                    updateSlot(r, i, { customTitle: slotTitle.value || null })
                  "
                />
              </div>
              @if ((s.purpose ||
              roomPlans()[r].purpose)===RoomPurpose.Entertainment &&
              !(s.customTitle || '').trim()) {
              <div class="form-text font-size-small text-danger mt-1">
                Podaj szczegóły rozrywki.
              </div>
              }

              <div class="mt-2">
                <button
                  type="button"
                  class="btn btn-outline-danger w-auto"
                  (click)="removeSlot(r, i)"
                >
                  Usuń slot
                </button>
              </div>
            </div>
            }
            <button
              type="button"
              class="btn btn-outline-primary"
              (click)="addSlot(r)"
            >
              Dodaj slot
            </button>
          </div>
          }
        </div>
        }
      </div>
      }

      <div class="form-group">
        <label class="text-start">Link do Facebooka</label>
        <input type="url" class="form-control" formControlName="facebookLink" />
      </div>

      <div class="form-group">
        <label class="text-start">Tagi (ustalane automatycznie)</label>
        <div class="chips">
          @for (t of form.value.tags; track t) {
          <span class="chip">{{ EventTagLabel[t] }}</span>
          }
        </div>
      </div>

      <div class="actions">
        <button type="submit" class="btn btn-primary">
          {{ isEdit() ? "Zapisz zmiany" : "Utwórz wydarzenie" }}
        </button>
      </div>
    </form>
  </div>

  <ng-template #eventSuccessToast
    ><strong>Sukces!</strong> Wydarzenie zostało zapisane.</ng-template
  >
  <ng-template #eventErrorToast
    ><strong>Błąd!</strong> Nie udało się zapisać wydarzenia.</ng-template
  >
</div>
