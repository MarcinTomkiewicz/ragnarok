<div class="hosts-list-section">
  @if (loadingSig()) {
  <div class="skeleton-grid">
    <div class="skeleton-card" *ngFor="let i of [1, 2, 3, 4]"></div>
  </div>
  } @else if (errorSig()) {
  <div class="error">{{ errorSig() }}</div>
  } @else if (isFullSpan()) {
  <div class="fullspan-wrapper">
    @if (fullSpanImage()) {
    <div class="fullspan-media">
      <img
        [src]="fullSpanImage()!"
        [alt]="fullSpanTitle()"
        loading="lazy"
        decoding="async"
      />
    </div>
    }
    <h3 class="section-title text-center">{{ fullSpanTitle() }}</h3>

    <table class="table table-dark-style align-middle font-size-small w-100">
      <tbody>
        <tr>
          <th scope="row">Salka:</th>
          <td>{{ filterRoom() || "—" }}</td>
        </tr>

        <tr>
          <th scope="row">Godziny:</th>
          <td>
            {{ eventStart() || "00:00" | slice : 0 : 5 }} -
            {{ eventEnd() || "23:59" | slice : 0 : 5 }}
          </td>
        </tr>

        @if (fullSpanRequiresHosts()) {
        <tr>
          <th scope="row">Prowadzący:</th>
          <td>
            @if (fullSpanLeads().length) { @for (l of fullSpanLeads(); track
            l.id; let last = $last) { @if (l.clickable) {
            <button
              class="btn btn-outline btn-sm"
              (click)="openGmProfile(l.host, $event)"
            >
              {{ l.display }}
            </button>
            } @else {
            <span>{{ l.display }}</span>
            } @if (!last) { <span>, </span> } } } @else {
            <span>—</span>
            }
          </td>
        </tr>
        } @if (fullSpanDescription()) {
        <tr>
          <th scope="row">Opis:</th>
          <td>
            @let paragraphs = (fullSpanDescription() || '').split('\n'); @for
            (paragraph of paragraphs; let i = $index; track i) { @if
            (paragraph.trim().length) {
            <div>{{ paragraph }}</div>
            } }
          </td>
        </tr>
        } @if (showSignup() && fullSpanAllowsSignup()) {
        <tr>
          <th scope="row">Lista uczestników:</th>
          <td>
            <div class="fullspan-signups">
              <div class="actions">
                <app-session-signup-button
                  [eventId]="eventId()"
                  [dateIso]="dateIso()"
                  [currentUser]="currentUser()"
                  [capacity]="fullSpanCapacity()"
                  [roomName]="filterRoom()"
                  (signed)="onSessionSigned(filterRoom() || '')"
                />
              </div>
              <div class="participants mt-2">
                <app-participants-list
                  [eventId]="eventId()"
                  [dateIso]="dateIso()"
                  [scope]="{ roomName: filterRoom() || null }"
                  [currentUser]="currentUser()"
                  [refreshKey]="getRefreshKey(filterRoom() || '')"
                  [capacity]="fullSpanCapacity()"
                />
              </div>
            </div>
          </td>
        </tr>
        }
      </tbody>
    </table>
  </div>
  } @else if (!slidesForDisplay().length) {
  <div class="empty muted">
    Brak zgłoszonych pozycji na najbliższe wydarzenie.
  </div>
  } @else {
  <swiper-container
    class="mg-swiper attraction-swiper"
    slides-per-view="auto"
    space-between="16"
    navigation="true"
    speed="500"
  >
    <!-- [attr.loop]="slidesForDisplay().length > 4 ? 'true' : null" -->
    @for (h of slidesForDisplay(); track h.id) {
    <swiper-slide>
      <article
        class="session-card card-dark is-swiper"
        role="button"
        tabindex="0"
        (click)="!isVirtual(h) && openDetails(h)"
      >
        <div class="content">
          <h4 class="title-dark session-title">{{ h.title || "Pozycja" }}</h4>

          <div class="image-wrap" [class.is-placeholder]="isPlaceholder(h)">
            <span class="kind-row tag-badge {{ kindClass(h) }}">{{
              kindLabel(h)
            }}</span>
            <img
              [src]="h.imageUrl || '/ragnarok.avif'"
              [alt]="h.title || 'Ilustracja'"
              loading="lazy"
              decoding="async"
            />
          </div>

          @if (isSessionCard(h)) {
          <div class="meta-row">
            <span class="muted">System:</span>
            <span class="text-start">{{ h.system?.name || "—" }}</span>
          </div>
          } @if (filterRoom()) {
          <div class="meta-row">
            <span class="muted">Godziny:</span>
            <span class="text-start">{{ timeRangeLabel(h) }}</span>
          </div>
          } @else {
          <div class="meta-row">
            <span class="muted">Salka:</span>
            <span class="text-start">{{ h.roomName || "—" }}</span>
          </div>
          } @if (requiresHostsFor(h)) {
          <div class="meta-row">
            <span class="muted">Prowadzący:</span>
            @if (!isVirtual(h) && h.gm) {
            <button
              class="btn btn-primary btn-sm"
              (click)="openGmProfile(h, $event)"
            >
              {{ listDisplayName(h) }}
            </button>
            } @else {
            <span>{{ listDisplayName(h) }}</span>
            }
          </div>
          }

          <div class="meta-row tags mt-3">
            @if (h.playstyleTags.length && isSessionCard(h)) { @for (t of
            h.playstyleTags; track t) {
            <span class="tag-badge golden">{{ GmStyleTagLabels[t] }}</span>
            } }
          </div>

          @if (isSessionCard(h)) {
          <div class="triggers mt-2">
            @if (h.triggersTop.length || h.triggersExtraCount > 0) { @for (tr of
            h.triggersTop; track tr) {
            <span class="tag-badge violet">{{ tr }}</span>
            } @if (h.triggersExtraCount > 0) {
            <span class="tag-badge muted">+{{ h.triggersExtraCount }}</span>
            } } @else {
            <span class="sr-only">Brak triggerów</span>
            }
          </div>
          } @if (!isVirtual(h) && showSignup()) {
          <div class="signup-area" (click)="$event.stopPropagation()">
            <div class="actions">
              <app-session-signup-button
                [eventId]="eventId()"
                [dateIso]="dateIso()"
                [hostId]="h.id"
                [currentUser]="currentUser()"
                [capacity]="hostCapacity(h)"
                (signed)="onSessionSigned(h.id)"
              />
            </div>

            <div class="participants mt-2">
              <app-participants-list
                [eventId]="eventId()"
                [dateIso]="dateIso()"
                [scope]="{ hostId: h.id }"
                [currentUser]="currentUser()"
                [refreshKey]="getRefreshKey(h.id)"
                [capacity]="hostCapacity(h)"
              />
            </div>
          </div>
          }
        </div>
      </article>
    </swiper-slide>
    }
  </swiper-container>
  }
</div>
